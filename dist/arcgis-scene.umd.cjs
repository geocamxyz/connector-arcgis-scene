(function(H,j){typeof exports=="object"&&typeof module<"u"?j(exports):typeof define=="function"&&define.amd?define(["exports"],j):(H=typeof globalThis<"u"?globalThis:H||self,j(H.arcgisScene={}))})(this,function(H){"use strict";var j=typeof window<"u";const ne={Promise:j?window.Promise:void 0};var oe="4.25",X="next";function re(t){if(t.toLowerCase()===X)return X;var n=t&&t.match(/^(\d)\.(\d+)/);return n&&{major:parseInt(n[1],10),minor:parseInt(n[2],10)}}function ae(t){return t===void 0&&(t=oe),"https://js.arcgis.com/".concat(t,"/")}function ze(t){t===void 0&&(t=oe);var n=ae(t),e=re(t);if(e!==X&&e.major===3){var a=e.minor<=10?"js/":"";return"".concat(n).concat(a,"esri/css/esri.css")}else return"".concat(n,"esri/themes/light/main.css")}function Ve(t){var n=document.createElement("link");return n.rel="stylesheet",n.href=t,n}function Te(t,n){if(n){var e=document.querySelector(n);e.parentNode.insertBefore(t,e)}else document.head.appendChild(t)}function Ne(t){return document.querySelector('link[href*="'.concat(t,'"]'))}function Me(t){return!t||re(t)?ze(t):t}function He(t,n){var e=Me(t),a=Ne(e);return a||(a=Ve(e),Te(a,n)),a}var Ie={};function $e(t){var n=document.createElement("script");return n.type="text/javascript",n.src=t,n.setAttribute("data-esri-loader","loading"),n}function se(t,n,e){var a;e&&(a=Ge(t,e));var u=function(){n(t),t.removeEventListener("load",u,!1),a&&t.removeEventListener("error",a,!1)};t.addEventListener("load",u,!1)}function Ge(t,n){var e=function(a){n(a.error||new Error("There was an error attempting to load ".concat(t.src))),t.removeEventListener("error",e,!1)};return t.addEventListener("error",e,!1),e}function ie(){return document.querySelector("script[data-esri-loader]")}function Z(){var t=window.require;return t&&t.on}function Be(t){t===void 0&&(t={});var n={};[Ie,t].forEach(function(u){for(var m in u)Object.prototype.hasOwnProperty.call(u,m)&&(n[m]=u[m])});var e=n.version,a=n.url||ae(e);return new ne.Promise(function(u,m){var h=ie();if(h){var q=h.getAttribute("src");q!==a?m(new Error("The ArcGIS API for JavaScript is already loaded (".concat(q,")."))):Z()?u(h):se(h,u,m)}else if(Z())m(new Error("The ArcGIS API for JavaScript is already loaded."));else{var I=n.css;if(I){var _=I===!0;He(_?e:I,n.insertCssBefore)}h=$e(a),se(h,function(){h.setAttribute("data-esri-loader","loaded"),u(h)},m),document.body.appendChild(h)}})}function ce(t){return new ne.Promise(function(n,e){var a=window.require.on("error",e);window.require(t,function(){for(var u=[],m=0;m<arguments.length;m++)u[m]=arguments[m];a.remove(),n(u)})})}function Pe(t,n){if(n===void 0&&(n={}),Z())return ce(t);var e=ie(),a=e&&e.getAttribute("src");return!n.url&&a&&(n.url=a),Be(n).then(function(){return ce(t)})}const Fe=(t,n)=>t.replace(/\(\?\<(.+?)\>[^)]*\)/g,(e,a)=>n[a]),k=(t,n={},e="")=>{const a=document.createElement(t);for(let u in n)a.setAttribute(u,n[u]);return a.innerHTML=e,a},Ue=(t,n)=>(document.getElementById(t)||document.getElementsByTagName("head")[0].prepend(k("STYLE",{type:"text/css"},n)),!0),Je=function(t={}){Ue("geocam-argis-map",`
      .geocam-auto-rotate-checkbox, .geocam-auto-brightness-checkbox {
        display: none;
      }

      .geocam-auto-rotate-span {
        background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24'  viewBox='0 0 24 24' fill='currentColor'><rect fill='none' height='24' width='24'/><path d='M7.94,5.12L6.49,3.66C8.07,2.61,9.96,2,12,2c5.52,0,10,4.48,10,10c0,2.04-0.61,3.93-1.66,5.51l-1.46-1.46 C19.59,14.86,20,13.48,20,12c0-4.41-3.59-8-8-8C10.52,4,9.14,4.41,7.94,5.12z M17.66,9.53l-1.41-1.41l-2.65,2.65l1.41,1.41 L17.66,9.53z M19.78,22.61l-2.27-2.27C15.93,21.39,14.04,22,12,22C6.48,22,2,17.52,2,12c0-2.04,0.61-3.93,1.66-5.51L1.39,4.22 l1.41-1.41l18.38,18.38L19.78,22.61z M16.06,18.88l-3.88-3.88l-1.59,1.59l-4.24-4.24l1.41-1.41l2.83,2.83l0.18-0.18L5.12,7.94 C4.41,9.14,4,10.52,4,12c0,4.41,3.59,8,8,8C13.48,20,14.86,19.59,16.06,18.88z'/></svg>")
      }

      .geocam-auto-rotate-checkbox:checked +.geocam-auto-rotate-span {
          background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24' viewBox='0 0 24 24' fill='currentColor'><rect fill='none' height='24' width='24'/><path d='M18.6,19.5H21v2h-6v-6h2v2.73c1.83-1.47,3-3.71,3-6.23c0-4.07-3.06-7.44-7-7.93V2.05c5.05,0.5,9,4.76,9,9.95 C22,14.99,20.68,17.67,18.6,19.5z M4,12c0-2.52,1.17-4.77,3-6.23V8.5h2v-6H3v2h2.4C3.32,6.33,2,9.01,2,12c0,5.19,3.95,9.45,9,9.95 v-2.02C7.06,19.44,4,16.07,4,12z M16.24,8.11l-5.66,5.66l-2.83-2.83l-1.41,1.41l4.24,4.24l7.07-7.07L16.24,8.11z'/></svg>")
      }

      .geocam-auto-brightness-span {
          background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'  enable-background='new 0 0 24 24' viewBox='0 0 24 24'  fill='currentColor'><path d='M0 0h24v24H0V0z' fill='none'/><path d='M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zm-2 5.79V18h-3.52L12 20.48 9.52 18H6v-3.52L3.52 12 6 9.52V6h3.52L12 3.52 14.48 6H18v3.52L20.48 12 18 14.48zM12 6.5c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5zm0 9c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z'/></svg>");
      }

      .geocam-auto-brightness-checkbox:checked +.geocam-auto-brightness-span {
          background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' enable-background='new 0 0 24 24' viewBox='0 0 24 24' fill='currentColor'><path d='M0 0h24v24H0V0z' fill='none'/><path d='M11 7l-3.2 9h1.9l.7-2h3.2l.7 2h1.9L13 7h-2zm-.15 5.65L12 9l1.15 3.65h-2.3zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zm-2 5.79V18h-3.52L12 20.48 9.52 18H6v-3.52L3.52 12 6 9.52V6h3.52L12 3.52 14.48 6H18v3.52L20.48 12 18 14.48z'/></svg>")
      }

     .geocam-auto-brightness-checkbox:disabled +.geocam-auto-brightness-span {
          opacity: 50%;
          cursor: auto;
          background-image: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'  enable-background='new 0 0 24 24' viewBox='0 0 24 24'  fill='currentColor'><path d='M0 0h24v24H0V0z' fill='none'/><path d='M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zm-2 5.79V18h-3.52L12 20.48 9.52 18H6v-3.52L3.52 12 6 9.52V6h3.52L12 3.52 14.48 6H18v3.52L20.48 12 18 14.48zM12 6.5c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5 5.5-2.47 5.5-5.5-2.47-5.5-5.5-5.5zm0 9c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z'/></svg>");
      }

    `);let e,a,u=[],m,h,q,I,_,ue,O,$,R,G,de,D,me,K,ge,fe,he,pe,ve,be,je,we,qe,ye=!0,Le;const{sceneView:s,prevNextPlugin:W,widgets:Ke,expands:Qe,src:ee}=t,xe=function(o,i,c,r,l){return 1/Math.sqrt(s.scale/70),{geometry:{type:"point",latitude:c,longitude:i,z:r},symbol:{type:"point-3d",symbolLayers:[{type:"object",width:8,height:4,depth:8,anchor:"top",resource:{primitive:"cone"},roll:0,tilt:l,heading:o,material:{color:"rgba(0,0,255,0.6)"}}]}}};let x=xe(0,0,0,0,90);const A=function(o,i,c,r,l){if(console.log("update fov",o,i,c,r,l),m&&(m.removeAll(),e.visible()&&o!==null))if($()){const p=s.camera.clone();(c||c===0)&&(p.position.latitude=c),(i||i===0)&&(p.position.longitude=i),(r||r===0)&&(p.position.z=r),(o||o===0)&&(p.heading=o),(l||l===0)&&(p.tilt=90-l),p.fov=parseInt(e.fov()),console.log("camera fov",p),s.goTo(p,{animate:!1}),s.camera.fov=e.fov()}else x=xe(o||0,i||x.geometry.longitude,c||x.geometry.latitude,r||x.geometry.z,l?90-l:x.symbol.symbolLayers[0].tilt),m.add(x),(c||c===0)&&Le([i,c])},ke=function(o,i,c={}){const r=new RegExp(i,"i");let l=r.test(o.name)||r.test(o.alias);return l&&c.description&&(l=!!o.description),l},Se=function(o){if(o){var i=document.createElement("textarea");return i.innerHTML=o,i.value}else return"https://image.geocam.xyz/"},Oe=(o,i)=>{const c=o.base;if(o.filenames)return JSON.parse(i[o.filenames]).map(r=>Array.isArray(r)?r.map(l=>/^https?:\/\//i.test(l)?r:`${c}${l}`):/^https?:\/\//i.test(r)?r:`${c}${r}`);{const r=i[o.capture].split(".")[0],l=r.split("/").pop(),p=JSON.parse(i[o.lengths]),b=JSON.parse(i[o.offsets]);return p.map((w,y)=>{const z=encodeURIComponent(`https://s3.us-west-004.backblazeb2.com/gc-raw-surveys-archive/${r}_${y}.tar`);return`${c}${l}/${y}/${i[o.shot]}.jpg?offset=${b[y]}&length=${w}&container=${z}`})}},Re=function(o){return u.findIndex(i=>i.layer==o.layer)},De=function(o){if(e.label){const{capture:i,utc_time:c,shot:r}=o,l=new Date(c);e.label(`${l.toLocaleString()}`)}};let Ee;const te=function(o,i){const c=K();console.log("shotclick with viewlock",c);const r=u[i],l=o.attributes[r.shot];Ee=l,e.shot(l),W&&(W.prev(o.attributes.prev),W.next(o.attributes.next));const p=[0,1,2].map(z=>Fe(r.calibrationBase,{camera:z,rig_id:o.attributes[r.rigId],calibration:o.attributes[r.calibration]})),b=o.attributes[r.yaw],E=o.attributes[r.rotation],w=G()&&r.brightness?o.attributes[r.brightness]:null;de=w;const y=Oe(r,o.attributes);if(c){const z=bearing(o.geometry,c);e.facing(z)}e.show(y,b,p,E,w),A(e.facing(),o.geometry.longitude,o.geometry.latitude,o.geometry.z,e.horizon()),De(o.attributes)};let Ce;const Ae=function(o,i,c,r){clearTimeout(Ce),Ce=setTimeout(()=>{const p=Math.ceil(o/500),b=s.extent,E=`${b.xmin},${b.ymin},${b.xmax},${b.ymax},${b.spatialReference.wkid}`,w=`mod(id,${p}) = 0 AND extent = ${E}`;u.forEach(y=>{y.layer.definitionExpression!==w&&(y.layer.definitionExpression=w,console.log("definition expression changed for",y.layer,w))}),me(s.zoom),$()||A(e.facing())},500)},Ye=function(o,i,c,r){we([s.center.longitude,s.center.latitude])},_e=function(o,i,c,r){ge(s.camera.position.latitude),fe(s.camera.position.longitude),pe(s.camera.position.z),ve(s.camera.tilt),he(s.camera.heading),be(s.camera.fov)};this.init=async function(o){e=o,Le=e.store("marker"),me=e.store("zoom"),we=e.store("center"),ge=e.store("camLat"),fe=e.store("camLng"),pe=e.store("camAlt"),ve=e.store("camTilt"),he=e.store("camHdg"),be=e.store("camFov"),K=e.store("viewlock"),$=e.store("autorotate"),O=k("DIV",{class:"geocam-auto-rotate"});const i=k("LABEL",{class:"geocam-auto-rotate-label"}),c=k("INPUT",{type:"checkbox",class:"geocam-auto-rotate-checkbox"}),r=k("SPAN",{class:"geocam-auto-rotate-span geocam-viewer-control-button"}," Autorotate");c.checked=$(),c.addEventListener("change",()=>{$(c.checked)}),i.appendChild(c),i.appendChild(r),O.appendChild(i),e.addControl(O,"left-top"),I=$(d=>{O.setAttribute("title",d?"turn auto-rotate off":"turn auto-rotate on"),A(e.facing(),x.geometry.longitude,x.geometry.latitude,x.geometry.z,e.horizon())}),G=e.store("autobrightness"),R=k("DIV",{class:"geocam-auto-brightness"});const l=k("LABEL",{class:"geocam-auto-brightness-label"});D=k("INPUT",{type:"checkbox",class:"geocam-auto-brightness-checkbox"});const p=k("SPAN",{class:"geocam-auto-brightness-span geocam-viewer-control-button"}," Autobrightness");D.checked=G(),D.addEventListener("change",()=>{G(D.checked)}),l.appendChild(D),l.appendChild(p),R.appendChild(l),e.addControl(R,"left-top"),_=G(d=>{R.setAttribute("title",d?"turn auto-brightness off":"turn auto-brightness on"),e.reload(G()?de:"[1,1,1]")}),ue=e.visible(d=>A(e.facing()));const[b,E,w]=await Pe(["esri/layers/GraphicsLayer","esri/core/reactiveUtils","esri/layers/FeatureLayer"],{version:"4.26"});if(s.when(async()=>{s.on("clickable",g=>{ye=g}),s.on("immediate-click",g=>{if(!ye)return;const f={x:g.x,y:g.y};if(console.log("immediate-click",g,f),a){console.log("space wqas down");const v=s.toMap(f);if(K(v),lockG&&s.graphics.removeAll(),lockG=lockGraphic(v),s.graphics.add(lockG),e.visible()){const N=bearing(x.geometry,v);e.facing(N)}}else s.hitTest(f).then(v=>{if(v.results&&v.results.length>0)for(var N=0;N<v.results.length;N++){const L=v.results[N].graphic,M=Re(L);if(M>=0){Object.entries(L.attributes).length<2?L.layer.queryFeatures({objectIds:[L.attributes.id],returnGeometry:!0,outFields:"*",where:L.layer.definitionExpression}).then(Q=>{Q.features.length>0&&te(Q.features[0],M)}):te(L,M);break}}})}),h=e.facing(g=>{A(g,null,null,null,e.horizon())}),q=e.horizon(g=>{A(e.facing(),null,null,null,g)});const d=new URLSearchParams(window.location.hash.substr(1)),V=d.get("center");V&&V!=="null"&&(s.center=JSON.parse(V));const B=d.get("zoom");B&&B!=="null"&&(s.zoom=JSON.parse(B));const S=s.camera.clone(),P=d.get("camLat");P&&P!=="null"&&(S.position.latitude=JSON.parse(P));const F=d.get("camLng");F&&F!=="null"&&(S.position.longitude=JSON.parse(F));const U=d.get("camAlt");U&&U!=="null"&&(S.position.z=JSON.parse(U));const Y=d.get("camHdg");Y&&Y!=="null"&&(S.heading=JSON.parse(Y));const C=d.get("camTilt");C&&C!=="null"&&(S.tilt=JSON.parse(C));const J=d.get("camFov");J&&J!=="null"&&(S.fov=JSON.parse(J)),s.goTo(S,{animate:!1});const T=d.get("marker");if(T){const g=JSON.parse(T);if(g){const[f,v]=g;A(e.facing(),f,v)}}E.watch(()=>s.scale,Ae),Ae(s.scale),E.watch(()=>s.center,Ye),E.watch(()=>s.camera.position,_e),e.shot(g=>{const f=parseInt(typeof g=="object"&&g!==null?g.id:g);f&&f!==Ee?(console.log("Got shot",g,"layers",u.length),u.forEach((v,N)=>{const L=v.layer;e.resetProgress(),console.log("Querying layer for shot",L,f),L.queryFeatures({objectIds:[f],returnGeometry:!0,outFields:"*",where:L.definitionExpression}).then(M=>{if(console.log("Got results for layer",L,M),M.features.length>0){const Q=M.features[0];te(Q,N)}})})):g||e.hide()})}),ee){const d=`${ee}/0`;console.log("shots url is",d);const V=new w({url:d,definitionExpression:"mod(id,100) = 0"});s.map.add(V),V.when(P=>{const F=P.fields,U=F.find(f=>ke(f,"filenames")),Y=F.find(f=>ke(f,"calibration"));u.push({layer:V,shot:"id",filenames:"filenames",yaw:"yaw",rotation:"rotation_matrix",datetime:"utc_time",brightness:null,base:Se(U&&U.description),calibration:"calibration",rigId:null,calibrationBase:Se(Y.description),capture:"capture"});const C=3e-4,J={xmin:-C,ymin:-C,xmax:C,ymax:C},T=Object.keys(J),g={};for(let f=0;f<T.length;f++)g[T[f]]=parseFloat(P.fullExtent[T[f]])+J[T[f]];s.extent=g});const B=`${ee}/1`;console.log("points features url is",B);const S=new w({url:B,popupEnabled:!0,popupTemplate:{title:"{reference}",content:[{type:"fields",fieldInfos:[{fieldName:"embed",label:"content"}]}]}});s.map.add(S)}m=new b({title:"GeoCam Field of View",geometryType:"point",spatialReference:{wkid:4326}}),s.map.layers.add(m);var y=function(d){switch(d.key,d.key){case"Escape":{K(null),mapView.graphics.removeAll();break}case" ":a=!0}},z=function(d){switch(d.key,d.key){case" ":a=!1}};document.addEventListener("keydown",y),document.addEventListener("keyup",z)},this.destroy=function(){h(),q(),I(),_(),je(),qe(),ue(),s.map.removeLayer(m),e.wrapper.removeChild(O),e.wrapper.removeChild(R)}};class le extends HTMLElement{constructor(){super(),this.plugin=null,console.log("GeocamViewerArcgisScene init")}connectedCallback(){this.link=function(n){console.log("linking to ",n);const e=this.getAttribute("src");e||console.warn("No src attribute on geocam-viewer-arcgis-scene");const a=this.parentNode;if(this.viewer=a.viewer,this.sceneView=n,this.viewer&&this.viewer.plugin){const u=document.getElementsByTagName("geocam-viewer-prev-next-control")[0],m=u&&u.plugin;this.plugin=new Je({sceneView:n,prevNextPlugin:m,src:e}),a.viewer.plugin(this.plugin);const h=a.getElementsByTagName("geocam-viewer-screen-shot")[0];h&&h.plugin&&h.plugin.arcgisView(n)}else console.error("GeocamViewerArcgisScene must be a child of GeocamViewer")},console.log("GeocamViewerArcgisScene connected")}disconnectedCallback(){this.plugin=null,this.viewer=null,this.sceneView=null,console.log("GeocamViewerArcgisScene disconnected")}}window.customElements.define("geocam-viewer-arcgis-scene",le),H.GeocamViewerArcgisScene=le,Object.defineProperty(H,Symbol.toStringTag,{value:"Module"})});
